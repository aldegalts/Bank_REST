databaseChangeLog:
    - changeSet:
          id: 002-create-cards
          author: aldegalts
          changes:
              - createTable:
                    tableName: cards
                    columns:
                        - column:
                              name: id
                              type: UUID
                              constraints:
                                  primaryKey: true
                                  nullable: false
                        - column:
                              name: owner_id
                              type: BIGINT
                              constraints:
                                  nullable: false
                        - column:
                              name: card_number_enc
                              type: TEXT
                              constraints:
                                  nullable: false
                        - column:
                              name: card_number_fingerprint
                              type: CHAR(64)
                              constraints:
                                  nullable: false
                        - column:
                              name: last4
                              type: CHAR(4)
                              constraints:
                                  nullable: false
                        - column:
                              name: expiry_month
                              type: SMALLINT
                              constraints:
                                  nullable: false
                        - column:
                              name: expiry_year
                              type: SMALLINT
                              constraints:
                                  nullable: false
                        - column:
                              name: status
                              type: VARCHAR(20)
                              constraints:
                                  nullable: false
                        - column:
                              name: balance
                              type: DECIMAL(19,2)
                              defaultValueNumeric: 0.00
                        - column:
                              name: version
                              type: INT
                              defaultValueNumeric: 0
                        - column:
                              name: created_at
                              type: TIMESTAMP
                              defaultValueComputed: CURRENT_TIMESTAMP
                        - column:
                              name: updated_at
                              type: TIMESTAMP
                              defaultValueComputed: CURRENT_TIMESTAMP

              - addForeignKeyConstraint:
                    baseTableName: cards
                    baseColumnNames: owner_id
                    referencedTableName: users
                    referencedColumnNames: id
                    constraintName: fk_cards_users

              - addUniqueConstraint:
                    tableName: cards
                    columnNames: card_number_fingerprint
                    constraintName: uq_cards_fingerprint

              - createIndex:
                    tableName: cards
                    indexName: idx_cards_owner
                    columns:
                        - column:
                              name: owner_id

              - createIndex:
                    tableName: cards
                    indexName: idx_cards_status
                    columns:
                        - column:
                              name: status

          rollback:
              - dropTable:
                    tableName: cards
